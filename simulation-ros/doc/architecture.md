# Architecture for the Warehouse Robots

## 1. Overview

This document presents details about the ROS architecture used within the warehouse controller. 
The architecture focuses on presenting the communication between the robots and the digital twins. It also gives an understanding of how the data generated by the robots are sent to the warehouse controller, through the digital twings.

Specifically, this architecture is based on the Turtlebot2i (equipped with a robotic arm, cameras and a LIDAR) running on ROS. As simulated environment (comprised by robots, conveyor belts, shelves, trucks and workers) also can be used, this architecture supports the use of V-REP simulator together with ROS.

## 2. Architecture

There are two possible scenarios of the architecture, one using simulated environment and another using the real robots:

### 2.1. Simulated Scenario

The robots and the warehouse are simulated by V-REP and all the information are gathered from the simulator. In this scenario a single *ROS MASTER* is used which centralizes the communication between the digital twins and the simulated robots. All the physical components of the warehouse are modeled and simulated by V-REP, such as robots, shelves and conveyor belts. Regards to ROS, it is responsible to process the simulated data generated by V-REP (camera, lidar) and send the appropriate controls to the robots. For this, data generated by V-REP are converted to ROS Messages. The *ROS_INTERFACE* is responsible to provide to V-REP the support for ROS messages. To control the robotic arms, specifically, the *ROS API* is used which use ports to flow the messages.

The main components of the architecture in the simulated scenario setting are:

- **V-REP:** Models all the physical components of the warehouse. It also simulates the behavior of the warehouse and through the GUI interface it is possible to visualize the results. It is important to highlight that V-REP does not perform any control of the robots, but the conveyor belts, shelves, trucks and workers. 

- **Robot ROS Nodes:** Contains all the algorithms responsible to process the simulated sensor data (camera, lidar, odometer) to then send actuation commands to the simulated robots. The algorithms are modeled using ROS libraries and all incoming/outcoming data flows in ROS message format. Examples of ROS nodes are localization, mapping, obstacle detection, motion planning and path planning.

- **ROS Master:** Centralizes the communication between the components of the architecture (only in the simulated setup) and makes possible the digital twins gather data from the simulated warehouse.

The following diagram depicts the architecture representing the components of the simulated scenario.

![ROS Architecture](https://github.com/EricssonResearch/scott-eu/blob/simulation-ros/simulation-ros/doc/ROS_multirobot_architecture_simulated.png)


### 2.2. Real Robots Scenario

In this scenario, it is used real robots equipped with its own computer and running ROS on top of it. Each robot has its own *ROS MASTER*, therefore, [ROS MultiMaster](http://wiki.ros.org/ROS/Tutorials/MultipleMachines) is used to perform communication between robots. The digital twins access the robot data from the *ROS MASTER* of each robot. All the robot algorithms are developed through ROS libraries, thus, it is intended to use the same algorithms of the simulated setup.

The main components of the architecture in the real robot setting are:

- **ROS Multimaster:** Enables the use of multiple ROS Master by providing the communication interface between them. Through this, one robot can communicate with other without having to pass the data through OSLC/MQTT layer.

- **ROS Master:** Provides the inner communication interface of the robot by centralizing all the components of the robot. It also is the common interface of the real robots to the *ROS Multimaster* and to the digital twins.

- **Robot ROS Nodes:** Contain all the methods necessary to run the robot, such as obstacle detection, localization and motion planning. Essentially, the same codes used in the simulated architecture are used. The algorithms are developed using ROS libraries and provides high level abstraction interface to the *Robot Hardware*.

- **Robot Harware:** Represents the real physical components of the robot, such as base robot, robot arm and sensors.

The following diagram depicts the architecture representing the components of the real robot scenario.

![ROS Architecture](https://github.com/EricssonResearch/scott-eu/blob/simulation-ros/simulation-ros/doc/ROS_multirobot_architecture_real.png)


### 2.3. Digital Twins

The digital twins provides an interface between the robots to the warehouse controller and keep tracking some of the robot information (e.g. battery level, wifi signal intensity). Therefore, it must have access to all the data generated by the real or simulated robots. In the first moment, the ROS messages are going to be used to communicate with the these robots. However, as all the robot information will flow to the digital twin and may cause an overhead in the communication, an alternative protocol is under discussion.
